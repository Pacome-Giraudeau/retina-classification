name: ML Retinal Disease Classification CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Permet le déclenchement manuel

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: pacome-giraudeau/retina-classification
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_LATEST: pacome-giraudeau/retina-classification:latest

jobs:
  # Build Docker image
  build-image:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.event_name == 'pull_request'
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=short
            type=ref,event=branch
            type=ref,event=pr
            latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # # Ajoutez ce job après le job 'build-image' ou avant 'test-lint'
  # test-docker-config:
  #   runs-on: ubuntu-latest
  #   needs: build-image
  #   if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4

  #     - name: Log in to GitHub Container Registry
  #       uses: docker/login-action@v3
  #       with:
  #         registry: ${{ env.REGISTRY }}
  #         username: ${{ github.actor }}
  #         password: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Pull built image
  #       run: |
  #         echo "=== Pulling Docker image ==="
  #         docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  #     - name: Test Docker image configuration
  #       run: |
  #         echo "=== Testing Docker image configuration ==="
          
  #         # Test 1: Vérifier que l'image existe
  #         echo "1. Checking if image exists..."
  #         docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
  #         # Test 2: Vérifier la taille de l'image (moins de 5GB par exemple)
  #         echo "2. Checking image size..."
  #         IMAGE_SIZE=$(docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --format='{{.Size}}')
  #         echo "Image size: $IMAGE_SIZE bytes"
  #         # Optionnel: Échec si l'image est trop grande
  #         # if [ $IMAGE_SIZE -gt 5000000000 ]; then
  #         #   echo "ERROR: Image is too large (>5GB)"
  #         #   exit 1
  #         # fi
          
  #         # Test 3: Vérifier les labels Docker
  #         echo "3. Checking Docker labels..."
  #         docker image inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} --format='{{json .Config.Labels}}' | jq .
          
  #         # Test 4: Tester le fonctionnement basique de l'image
  #         echo "4. Running basic container tests..."
          
  #         # Test 4.1: Vérifier que Python est installé
  #         echo "4.1 Testing Python installation..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} python --version
          
  #         # Test 4.2: Vérifier la version de pip
  #         echo "4.2 Testing pip installation..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} pip --version
          
  #         # Test 4.3: Vérifier les packages critiques
  #         echo "4.3 Testing critical packages..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} python -c "
  #         import sys
  #         try:
  #             import torch
  #             import torchvision
  #             import pandas as pd
  #             import numpy as np
  #             import yaml
  #             import PIL
  #             print('✓ All critical packages imported successfully')
  #             print(f'  Torch: {torch.__version__}')
  #             print(f'  Pandas: {pd.__version__}')
  #             print(f'  NumPy: {np.__version__}')
  #             sys.exit(0)
  #         except ImportError as e:
  #             print(f'✗ Import error: {e}')
  #             sys.exit(1)
  #         "
          
  #         # Test 4.4: Vérifier la structure du projet dans le conteneur
  #         echo "4.4 Testing project structure..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} sh -c "
  #         echo 'Checking required directories:'
  #         ls -la
  #         echo '---'
  #         [ -f 'requirements.txt' ] && echo '✓ requirements.txt exists' || echo '✗ requirements.txt missing'
  #         [ -f 'config.yaml' ] && echo '✓ config.yaml exists' || echo '✗ config.yaml missing'
  #         [ -d 'scripts' ] && echo '✓ scripts directory exists' || echo '✗ scripts directory missing'
  #         [ -f 'run.py' ] && echo '✓ run.py exists' || echo '✗ run.py missing'
  #         "
          
  #         # Test 4.5: Tester l'import des modules du projet
  #         echo "4.5 Testing project modules import..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} python -c "
  #         import sys
  #         sys.path.insert(0, '/app')
  #         try:
  #             # Essayer d'importer vos modules principaux
  #             # Remplacez par vos modules réels
  #             from config_manager import ConfigManager
  #             print('✓ ConfigManager imported successfully')
              
  #             # Tester la lecture de la configuration
  #             config_manager = ConfigManager('config.yaml')
  #             paths = config_manager.get_paths()
  #             print('✓ Configuration loaded successfully')
  #             print(f'  Found paths: {list(paths.keys())}')
              
  #             sys.exit(0)
  #         except Exception as e:
  #             print(f'✗ Error importing project modules: {e}')
  #             import traceback
  #             traceback.print_exc()
  #             sys.exit(1)
  #         "
          
  #         # Test 4.6: Vérifier les variables d'environnement
  #         echo "4.6 Testing environment variables..."
  #         docker run --rm --env PYTHONPATH=/app ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} python -c "
  #         import os
  #         print('PYTHONPATH:', os.environ.get('PYTHONPATH', 'Not set'))
  #         print('Current directory:', os.getcwd())
  #         "
          
  #         # Test 4.7: Tester une commande simple du projet
  #         echo "4.7 Testing project CLI..."
  #         docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} python mv --help 2>&1 || echo "Help command executed"
          
  #         echo "=== All Docker image tests passed ==="

  #     - name: Test Dockerfile health check (si présent)
  #       run: |
  #         echo "=== Checking Dockerfile configuration ==="
          
  #         # Vérifier si un HEALTHCHECK est défini
  #         if grep -q "HEALTHCHECK" Dockerfile; then
  #           echo "✓ HEALTHCHECK found in Dockerfile"
  #           HEALTHCHECK_CMD=$(grep -A1 "HEALTHCHECK" Dockerfile | tail -1)
  #           echo "  Health check command: $HEALTHCHECK_CMD"
  #         else
  #           echo "⚠ No HEALTHCHECK in Dockerfile (optional)"
  #         fi
          
  #         # Vérifier les ports exposés
  #         if grep -q "EXPOSE" Dockerfile; then
  #           echo "✓ EXPOSE found in Dockerfile"
  #           grep "EXPOSE" Dockerfile
  #         fi
          
  #         # Vérifier le WORKDIR
  #         if grep -q "WORKDIR" Dockerfile; then
  #           echo "✓ WORKDIR found in Dockerfile"
  #           grep "WORKDIR" Dockerfile
  #         fi

  #     - name: Clean up
  #       run: |
  #         echo "=== Cleaning up Docker images ==="
  #         # Supprimer l'image pour libérer de l'espace
  #         docker rmi ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} || true


  # Run linting tests
  test-lint:
    runs-on: ubuntu-latest
    needs:  [build-image]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies from requirements.txt
        run: |
          python -m pip install --upgrade pip
          # Installer les outils de linting + dépendances du projet
          pip install pylint black
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Run linting
        run: |
          echo "=== Linting Python files ==="
          # Vérifier si le dossier scripts existe
          if [ -d "scripts" ]; then
            pylint --fail-under=7.0 scripts/ || echo "Linting warnings detected"
          else
            echo "No scripts directory found"
          fi
          echo "=== Checking code format ==="
          # Vérifier quels dossiers existent
          if [ -d "scripts" ] || [ -d "tests" ]; then
            black --check scripts/ tests/ || echo "Format issues detected"
          else
            echo "No scripts or tests directories to check"
          fi

  # Run unit tests
  test-unit:
    runs-on: ubuntu-latest
    needs:  [build-image]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install system dependencies (pour Ubuntu 24.04)
        run: |
          sudo apt-get update
          # Pour Ubuntu 24.04, utiliser libgl1 au lieu de libgl1-mesa-glx
          sudo apt-get install -y libgl1 libglib2.0-0

      - name: Install Python dependencies from requirements.txt
        run: |
          python -m pip install --upgrade pip
          
          # Vérifier que requirements.txt existe
          if [ ! -f "requirements.txt" ]; then
            echo "ERROR: requirements.txt not found at project root!"
            exit 1
          fi
          
          echo "=== Installing dependencies from requirements.txt ==="
          pip install -r requirements.txt
          
          # Installer pytest en plus (pour les tests)
          pip install pytest pytest-cov
          
          echo "=== Installed packages ==="
          pip list | grep -E "(torch|pandas|numpy|yaml|pytest|pillow|scikit)"

      - name: Run unit tests
        run: |
          echo "=== Running unit tests ==="
          mkdir -p reports
          
          # Vérifier les imports critiques
          python -c "
          try:
              import pandas as pd
              import yaml
              import torch
              import torchvision
              print(f'✓ Pandas: {pd.__version__}')
              print(f'✓ PyYAML: {yaml.__version__}')
              print(f'✓ Torch: {torch.__version__}')
              print(f'✓ Torchvision: {torchvision.__version__}')
              print('All imports OK')
          except ImportError as e:
              print(f'✗ Import error: {e}')
              exit(1)
          "
          
          # Configurer matplotlib pour éviter les problèmes GUI
          export MPLBACKEND=Agg
          
          # Exécuter les tests
          pytest tests/tests_unitaires.py -v \
            --cov=scripts \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=term \
            --junitxml=reports/junit.xml \
            --tb=short

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/
          

  # Optional: Grype security scan (alternative à Docker Scout)
  security-scan:
    runs-on: ubuntu-latest
    needs: build-image
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Run security scan
        run: |
          grype ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --fail-on high \
            --output table \
            || echo "Vulnerabilities found above threshold"
