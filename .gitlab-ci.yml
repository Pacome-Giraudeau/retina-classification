# GitLab CI/CD Pipeline (lightweight version without Docker build)

stages:
  - test
  - train

# Run linting tests
test-lint:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --no-cache-dir pylint black
  script:
    - echo "=== Linting Python files ==="
    - pylint --fail-under=7.0 scripts/ || echo "Linting warnings detected"
    - echo "=== Checking code format ==="
    - black --check scripts/ tests/ || echo "Format issues detected"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Run unit tests
test-unit:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
    - pip install --no-cache-dir pytest pytest-cov
  script:
    - echo "=== Running unit tests ==="
    - mkdir -p reports
    - pytest tests/ -v --cov=scripts --cov-report=xml:reports/coverage.xml --cov-report=term
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: reports/coverage.xml
    paths:
      - reports/
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Train model with sample data (CI test)
train-test:
  stage: train
  image: python:3.9-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "=== Testing training pipeline with sample data ==="
    - python run.py --config config_ci.yaml train
    - echo "=== Checking if model was created ==="
    - ls -lh models/
    - test -f models/best_model_*.pt || (echo "No model found!" && exit 1)
  artifacts:
    paths:
      - models/
      - results/
    expire_in: 1 day
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Evaluate model
evaluate:
  stage: train
  image: python:3.9-slim
  before_script:
    - pip install --no-cache-dir -r requirements.txt
  script:
    - echo "=== Running model evaluation ==="
    - python run.py --config config_ci.yaml evaluate
    - echo "=== Evaluation completed ==="
    - ls -lh results/
  artifacts:
    paths:
      - results/
    expire_in: 1 week
  dependencies:
    - train-test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
